version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: webserver
      APP_PORT: 8000
      PROXY_AUTH_ADD: "false"

  paperless-redis:
    image: docker.io/library/redis:8-alpine@sha256:eadf354977d428e347d93046bb1a5569d701e8deb68f090215534a99dbfb6cdf
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/data/redisdata:/data
    user: "1000:1000"
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 200mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  paperless-db:
    image: docker.io/library/postgres:17-alpine@sha256:1d74239810c19ed0dbb317acae40974e673865b2d565a0d369e206159d483988
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/data/pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      POSTGRES_PASSWORD: paperless
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      POSTGRES_SHARED_PRELOAD_LIBRARIES: pg_stat_statements
      POSTGRES_MAX_CONNECTIONS: 100
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 256MB
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: 0.7
      POSTGRES_WAL_BUFFERS: 16MB
      POSTGRES_DEFAULT_STATISTICS_TARGET: 100
    user: "1000:1000"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U paperless -d paperless"]
      interval: 30s
      timeout: 10s
      retries: 3

  webserver:
    image: ghcr.io/paperless-ngx/paperless-ngx:2.18.4@sha256:7729fccc4a763ca85bac26b9c4a495b6816e59be8fbd27d29c0e773201bfc6e7
    restart: unless-stopped
    depends_on:
      - paperless-db
      - paperless-redis
      - paperless-gotenberg
      - paperless-tika
    volumes:
      # Internal app data - not accessible via Umbrel GUI
      - ${APP_DATA_DIR}/data/config:/usr/src/paperless/data
      # User-accessible directories via Umbrel file manager
      - ${UMBREL_ROOT}/data/storage/paperless/media:/usr/src/paperless/media
      - ${UMBREL_ROOT}/data/storage/paperless/export:/usr/src/paperless/export
      - ${UMBREL_ROOT}/data/storage/paperless/consume:/usr/src/paperless/consume
    environment:
      PAPERLESS_REDIS: redis://paperless-redis:6379
      PAPERLESS_DBHOST: paperless-db
      PAPERLESS_DBNAME: paperless
      PAPERLESS_DBUSER: paperless
      PAPERLESS_DBPASS: paperless
      PAPERLESS_DBPORT: 5432
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000
      PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
      PAPERLESS_TIME_ZONE: ${TZ:-Europe/Rome}
      PAPERLESS_OCR_LANGUAGE: ita+eng
      PAPERLESS_OCR_USER_ARGS: '{"invalidate_digital_signatures": true, "continue_on_soft_render_error": true}'
      PAPERLESS_SECRET_KEY: $APP_PASSWORD
      PAPERLESS_URL: http://${APP_DOMAIN:-localhost}:${APP_PORT:-8000}
      PAPERLESS_CSRF_TRUSTED_ORIGINS: http://${APP_DOMAIN:-localhost}:${APP_PORT:-8000},https://${APP_DOMAIN:-localhost}
      PAPERLESS_ALLOWED_HOSTS: ${APP_DOMAIN:-localhost},localhost,127.0.0.1,[::1]
      PAPERLESS_CORS_ALLOWED_HOSTS: http://${APP_DOMAIN:-localhost}:${APP_PORT:-8000},https://${APP_DOMAIN:-localhost}
      PAPERLESS_ENABLE_HTTP_REMOTE_USER: "false"
      PAPERLESS_CONSUMER_POLLING: 30
      PAPERLESS_CONSUMER_RECURSIVE: "true"
      PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS: "true"
      PAPERLESS_CONSUMER_IGNORE_PATTERN: '[".DS_Store", "._*", "Thumbs.db", "*.tmp", "*.temp"]'
      PAPERLESS_FILENAME_DATE_ORDER: DMY
      PAPERLESS_DATE_ORDER: DMY
      PAPERLESS_TASK_WORKERS: 2
      PAPERLESS_THREADS_PER_WORKER: 1
      PAPERLESS_WORKER_TIMEOUT: 3600
      PAPERLESS_PRE_CONSUME_SCRIPT: ""
      PAPERLESS_POST_CONSUME_SCRIPT: ""
      PAPERLESS_CONVERT_MEMORY_LIMIT: 128
      PAPERLESS_CONVERT_TMPDIR: "/tmp/paperless"
      PAPERLESS_OPTIMIZE_THUMBNAILS: "true"
      PAPERLESS_CONSUMER_DELETE_DUPLICATES: "true"
      PAPERLESS_NUMBER_OF_SUGGESTED_DATES: 3
      PAPERLESS_THUMBNAIL_FONT_NAME: "LiberationSerif"
      PAPERLESS_IGNORE_DATES: "1900-01-01,1970-01-01"
      PAPERLESS_REDIS_PREFIX: "paperless"
      PAPERLESS_ENABLE_NLTK: "true"
      PAPERLESS_EMAIL_TASK_CRON: "*/10 * * * *"
      PAPERLESS_TRAIN_TASK_CRON: "5 */8 * * *"
      PAPERLESS_INDEX_TASK_CRON: "0 0 * * sun"
      PAPERLESS_SANITY_TASK_CRON: "30 0 * * sun"
      PAPERLESS_ENABLE_FLOWER: "false"
      PAPERLESS_AUTO_LOGIN_USERNAME: ""
      PAPERLESS_ADMIN_USER: admin
      PAPERLESS_ADMIN_PASSWORD: $APP_PASSWORD
      PAPERLESS_ADMIN_MAIL: admin@example.com
      USERMAP_UID: 1000
      USERMAP_GID: 1000
    user: "1000:1000"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 512M
          cpus: "0.5"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/ui-settings/"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  paperless-gotenberg:
    image: docker.io/gotenberg/gotenberg:8.22@sha256:bcf6065a14dfa9afaa112a91eda0dd078d5d471869a58341307c07e98a6998f2
    restart: unless-stopped
    # The gotenberg chromium route is used to convert .eml files. We do not
    # want to allow external content like tracking pixels or even javascript.
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
      - "--chromium-disable-routes=true"
      - "--api-timeout=10m"
      - "--chromium-disable-web-security=true"
      - "--chromium-ignore-certificate-errors=true"
      - "--chromium-disable-dev-shm-usage=true"
      - "--chromium-no-sandbox=true"
    user: "1001:1001"
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"
    security_opt:
      - seccomp:unconfined
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 60s
      timeout: 30s
      retries: 3

  paperless-tika:
    image: docker.io/apache/tika:3.0.0@sha256:5a90f5c2a2e8e1c6b0eb3fb1e2b9fe92ba5f0df50f56e0b77be7b5c8b0c9f1e9
    restart: unless-stopped
    user: "1001:1001"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9998/version"]
      interval: 30s
      timeout: 10s
      retries: 3
